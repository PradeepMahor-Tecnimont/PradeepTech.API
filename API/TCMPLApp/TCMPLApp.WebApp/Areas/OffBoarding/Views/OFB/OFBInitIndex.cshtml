@model TCMPLApp.WebApp.Models.OFBInitViewModel
@inject TCMPLApp.WebApp.Services.SharedViewLocalizer localizer

@Html.AntiForgeryToken()

@{
    ViewData["Title"] = "Initiate Off-Boarding";
}

@section BreadCrumbs
    {
    <ol class="breadcrumb">
        <li class="breadcrumb-item "><a asp-action="OFBIndex" asp-controller="Home" asp-area="OffBoarding">Off-Boarding</a></li>
        <li class="breadcrumb-item active" aria-current="page">Init Off-Boarding</li>
    </ol>
}
@section Styles {
    <link href="@Url.Content("~/css/drome-style.css")" rel="stylesheet" type="text/css" asp-append-version="true" />
}
<form asp-controller="OFB"
      asp-action="InitDetails"
      id="formApprovalDetails">

    <input type="hidden" asp-for="Empno" name="id" id="Empno" />
</form>
<div class="container-fluid bg-white border rounded shadow m-auto col-xl-11 p-2 ">
    <div class="app-h4 app-card-header mb-2">
        <p>Init Off-Boarding</p>
    </div>

    <div class="d-flex flex-row">
        <a title="New OffBoarding Initiate" class="btn btn-outline-primary btn-sm border border-white" href="#"
           data-jqueryselector="openmodal"
           data-modalcontainer="modalcontainer"
           data-modalpopupwidth="rightw25"
           data-url='@Url.Action("SelectEmployee", "OFB", new { Area = "OffBoarding" })'
           data-statichtmlsourcedivid=""
           data-modaltitle="New OffBoarding Initiate"
           data-modalheader="New OffBoarding Initiate">
            <i class="fas fa-plus"></i> Create
        </a>
        <a style="float:right"
           class="btn btn-outline-success btn-sm border border-white mx-2 ml-auto"
           href="#"
           data-jqueryselector="openmodal"
           data-modalcontainer="modalcontainer"
           data-modalpopupwidth="rightw25"
           data-url='@Url.Action("OFBInitExcelDownload", "OFB", new { Area = "OffBoarding" })'>
            <i class="fas fa-file-excel green-color"></i>&nbsp;Export
        </a>
    </div>
    <div class="m-1"></div>
    <div class="bg-gray-active rounded ">
        <div class="input-group pt-1 pl-1 pr-1 ">
            <input type="text" class="form-control form-control-sm border" id="GenericSearch" name="GenericSearch" placeholder="Search...">
            <div class="input-group-append">
                <button class="btn btn-sm btn-outline-info" type="button" id="buttonSearch"><i class="fa fa-search"></i></button>
            </div>
        </div>
        <table id="tbOFBInit" class="table table-striped table-bordered table-responsive-lg ">
            <thead class="bg-info text-white">
                <tr>
                    <th>&nbsp;</th>
                    <th>@Html.DisplayNameFor(m => m.Empno)</th>
                    <th>@Html.DisplayNameFor(m => m.EmployeeName)</th>
                    <th>@Html.DisplayNameFor(m => m.Parent)</th>
                    <th>@Html.DisplayNameFor(m => m.DeptName)</th>
                    <th>@Html.DisplayNameFor(m => m.Grade)</th>
                    <th>@Html.DisplayNameFor(m => m.RelievingDate)</th>
                    <th>@Html.DisplayNameFor(m => m.Remarks)</th>
                    <th>@Html.DisplayNameFor(m => m.ApprovalStatus)</th>
                    <th>&nbsp;</th>
                    @* <th>&nbsp;</th> *@
                </tr>
            </thead>
        </table>
        <div id="result"></div>
    </div>
</div>

@section Scripts{

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
        await Html.RenderPartialAsync("_OFBDetailsDataTableColumnsPartial");

    }
    <script src="~/js/OFBDetails.js" asp-append-version="true"></script>

    <script>

        $(document).ready(function () {
            loadOFBInitDataTable();
            
        });

        function localScript() {
            initSelect2();
            initFilter();

            $('#btnExportOFBInitDetailsExcel').off('click').on('click', function () {
                event.preventDefault();
                event.stopPropagation();
                exportOFBInitDetailsExcel();
            });
        };

        let pvvUrlOFBInitList = '@Url.Action("GetListsOFBInit", "OFB")';

        function loadOFBInitDataTable() {
            genericLoadDataTable({
                pDataTableId: "#tbOFBInit",
                pColumns: datatableColumnsOFBInit,
                pUrl: pvvUrlOFBInitList,
                pUrlParams: {
                    genericSearch: $('#GenericSearch').val() ? $('#GenericSearch').val() : null,
                },
                pRequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),

            });
        }
        @if ((bool)@Context.Items["isMobile"] == false)
        {
            <text>
                let datatableColumnsOFBInit = [
                    {
                        data: null,
                        render: function (data, type, row) {
                            var Empno = "'" + data.empno + "'";
                            return '<button class="btn btn-sm-icon" href="#" onclick="GotoDetails(' + Empno + ')" title="Detail"><i class="far fa-eye"></i></button>';
                        },
                        className: "td-icon",
                    },
                    { 'data': "empno" },
                    { 'data': "employeeName" },
                    { 'data': "parent" },
                    { 'data': "deptName" },
                    { 'data': "grade" },
                    {
                        'data': "relievingDate",
                        'render': function (data) {
                            return moment(data).format('DD-MMM-YYYY');
                        }
                    },
                    { 'data': "remarks" },
                    {
                        data: null,
                        render: function (data, type, row) {
                            var approvalStatus = data.approvalStatus;
                            if (data.isRollbackInitiated == "OK") {
                                approvalStatus = "Rollback initiated";
                            }
                            return '<button name="ApprovalStatus" id="idApprovalStatus" title ="Approval Status" class="btn btn-link btn-sm border-none p-0" ' +
                                ' data-jqueryselector="openmodal" ' +
                                ' data-modalcontainer="modalcontainer" ' +
                                ' data-modalpopupwidth="rightw50" ' +
                                ' data-url="@Url.Action("GetAllApprovals", "OFB", new { Area = "OffBoarding" })" ' +
                                ' data-id="' + data.empno + '"' +
                                ' data-empname="' + data.employeeName + '"' +
                                ' data-parent="' + data.parent + '"' +
                                ' data-deptname="' + data.deptName + '"' +
                                ' data-relivevingdate="' + data.relievingDate + '"' +
                                ' data-modaltitle="Approval Details" ' +
                                ' data-callback="loadApprovalsList" ' +
                                ' data-modalheader="Approval Details"> ' + approvalStatus + '</button>';
                        },
                    },
                    {
                        'data': null,
                        render: function (data, type, row) {
                            var temp = "'" + data.empno + "'";
                            return '<a class="btn btn-outline-primary btn-sm border-none" href="@Url.Action("OFBInitEdit", "OFB")' + '/' + data.empno + '"  title="Edit"><i class="fas fa-edit"></i></a>';
                        },
                        'className': "td-icon",
                    },
                    // {
                    //     data: null,
                    //     render: function (data, type, row) {
                    //         if (data.rollBackAllowed == 0) {
                    //             return '<button title="Rollback" class="btn btn-outline-danger btn-sm border-none" ' +
                    //                 ' data-jqueryselector="openmodal" ' +
                    //                 ' data-modalcontainer="modalcontainer" ' +
                    //                 ' data-modalpopupwidth="rightw50" ' +
                    //                 ' data-url="@Url.Action("OFBRollback", "OFB", new { Area = "OffBoarding" })" ' +
                    //                 ' data-empno="' + data.empno + '"' +
                    //                 ' data-modaltitle="OffBoarding Rollback" ' +
                    //                 ' data-modalheader="OffBoarding Rollback"> ' +
                    //                 ' <i class="fas fa-undo" aria-hidden="true"></i> ' +
                    //                 ' </button>'
                    //         } else {
                    //             return '';
                    //         }
                    //     },
                    //     className: "td-icon",
                    // }
                ];

            </text>
        }

            function exportOFBInitDetailsExcel() {

                let vStartYear = $("#formOFBInitDetailsExcel input[id=StartYear]").val();
                let vEndYear = $("#formOFBInitDetailsExcel input[id=EndYear]").val();

                if (vStartYear > vEndYear) {
                    toastr.error('Please Select Valid End Year.! ');
                    return;
                }
                if (vStartYear == null || vStartYear == '') {
                    toastr.error('Invalid Start Year ');
                    return;
                }
                if (vEndYear == null || vEndYear == '') {
                    toastr.error('Invalid End Year');
                    return;
                }
                $.ajax({
                    headers: { "RequestVerificationToken": $('#OFBInitExcelDownload input[name="__RequestVerificationToken"]').val() },
                    url: '@Url.Action("OFBInitExcelDownload", "OFB", new {Area = "OffBoarding" })',
                    type: "POST",
                    data: {
                        startYear: vStartYear,
                        endYear: vEndYear
                    },
                    cache: false,
                    xhr: function () {
                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState == 2) {
                                if (xhr.status == 200) {
                                    xhr.responseType = "blob";
                                }
                            }
                        };
                        return xhr;
                    },
                    beforeSend: function () {
                        showLoader();
                        $("#btnExportOFBInitDetailsExcel").hide();
                        $('#OFBInitDetails_Loader').removeClass("hidden");
                    },

                    success: function (blob, status, xhr) {

                        var filename = "";
                        var disposition = xhr.getResponseHeader('Content-Disposition');
                        if (disposition && disposition.indexOf('attachment') !== -1) {
                            var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                            var matches = filenameRegex.exec(disposition);
                            if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                        }
                        var link = document.createElement('a');
                        var url = window.URL.createObjectURL(blob);

                        link.href = window.URL.createObjectURL(blob);
                        link.download = filename;
                        link.click();
                        link.remove();
                        window.URL.revokeObjectURL(url);
                        toastr.success("File downloaded successfully.");
                        hideLoader();
                        $("#modalcontainer").modal('hide');

                        $("#btnExportOFBInitDetailsExcel").show();
                        $('#OFBInitDetails_Loader').addClass("hidden");
                    },
                    error: function (xhr) {
                        showError(xhr);
                        hideLoader();
                        $("#btnExportOFBInitDetailsExcel").show();
                        $('#OFBInitDetails_Loader').addClass("hidden");
                    }
                });
            }

        function initFilter() {

            $('.datepickerFilter').bootstrapMaterialDatePicker({
                format: 'DD-MMM-YYYY',
                weekStart: 0,
                time: false,
                useCurrent: false
            });

            var curdate = new Date();

            var minYear = curdate.getFullYear() - 1;
            var maxYear = curdate.getFullYear();

            $('.selectYearFilter').datepicker({
                format: "yyyy",
                startView: "years",
                minViewMode: "years",
                maxViewMode: "years",
                changeYear: true,
                clearBtn: true,
                defaultViewDate: {
                    year: maxYear
                },
                endDate: 'y'
            });

            $('#startYearFilter').datepicker({
                format: 'yyyy',
                changeYear: true,

            }).on('change', function (e, date) {

                var fvDate = $(this).val();
                if (fvDate) {
                    $("#StartYear").val(moment(fvDate, 'YYYY').format("YYYY"));
                    
                    var vStartYear = $("#StartYear").val();
                    var curdate = new Date();
                    var curYear = curdate.getFullYear();

                    if (curYear - vStartYear <=2) {
                        $('#endYearFilter').datepicker('setYear', curYear);
                        $('#endYearFilter').val(moment(curYear, 'YYYY').format('YYYY'));
                        $("#EndYear").val(moment(curYear, 'YYYY').format('YYYY'));
                    }
                    else {
                        var setYear = parseInt(vStartYear) + 2;
                        $('#endYearFilter').datepicker('setYear', setYear);
                        $('#endYearFilter').val(moment(setYear, 'YYYY').format('YYYY'));
                        $("#EndYear").val(moment(setYear, 'YYYY').format('YYYY'));
                    }
                }
                else {
                    $("#StartYear").val("");
                }
                $(this).datepicker('hide');
            });
            if ($("#StartYear").val()) {
                $('#startYearFilter').val(moment($("#StartYear").val(), "YYYY").format('YYYY'));
            }
            
            $('#endYearFilter').datepicker({
                format: 'yyyy',
                changeYear: true,

            }).on('change', function (e, date) {

                var fvDate = $(this).val();
                if (fvDate) {
                    $("#EndYear").val(moment(fvDate, 'YYYY').format("YYYY"));
                }
                else {
                    $("#EndYear").val("");
                }
                $(this).datepicker('hide');
            });
            if ($("#EndYear").val()) {
                $('#endYearFilter').val(moment($("#EndYear").val(), "YYYY").format('YYYY'));
            }
        }

        $("#GenericSearch").keypress(function (event) {
            if (event.keyCode === 13) {
                if ($("#GenericSearch").length) {
                    loadOFBInitDataTable();
                }
            }
        });

        $('#buttonSearch').on('click', function () {

            if ($("#GenericSearch").length) {
                loadOFBInitDataTable();
            }
        });
        function PostDeleteReLoadDataTables(data) {
            if (data.success) {
                //loadOFBInitDataTable();
                hideLoader();
                notify('success', data.message, 'Success');
            }
        };
        function PostSave(data) {
            if (data.success) {
                loadOFBInitDataTable();
                hideLoader();
                $("#modalcontainer").modal('hide');
                notify('success', data.response, 'Success');
            }
        };
        function GotoDetails(id) {

            $('#Empno').val(id);
            var frm = $('#formApprovalDetails');
            frm.submit();
        }
    </script>
}