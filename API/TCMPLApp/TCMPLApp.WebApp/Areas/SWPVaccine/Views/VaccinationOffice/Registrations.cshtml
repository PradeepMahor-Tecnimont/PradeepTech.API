@{
    ViewData["Title"] = "TCMPL Vaccination Drive - Registrations";

    Html.AntiForgeryToken();
}

<div class="container-fluid bg-gray-active border rounded shadow m-auto p-2">
    
        <div class="app-h4 app-card-header mb-2">
            <p>TCMPL Vaccination Drive - Registrations</p>
        </div>
        <div class="text-right">
            <div class="text-right">
                <button name="ExcelDownload" id="idExcelDownload" title="Excel Download"
                        class=" btn btn-sm btn-success ">
                    <i class="far fa-file-excel green-color "></i>
                </button>
            </div>
            <hr class="m-1" />
        </div>
        <div class="childcontent-div" id="div-registrationlist">
            <div id="pv-registrationlist">
            </div>
        </div>
        <div id="result"></div>
    
</div>

@section Scripts
{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        $(document).ready(function () {
            showLoader();
            loadRegistrations();
            hideLoader();
        });

        function loadRegistrations() {
            var divid = $("#pv-registrationlist");
            $.ajax({
                url: '@Url.Action("RegistrationList", "VaccinationOffice")',
                data: {
                },
                type: 'GET',
                beforeSend: function () {
                },
                success: function (data) {
                    divid.html(data);
                    $("#registrations").DataTable({
                        pagingType:'full'
                    });
                    loadGridEvents();
                },
                error: function (result) {
                    hideLoader();
                    notify("error", result.responseText, 'danger');
                }
            });
        }

        function loadGridEvents() {
            $('#registrations tbody').on('click', 'td #idRemoveRegistration', function () {
                deleteRegistration(this);
            });
        }

        function deleteRegistration(object) {

            var confirmationtext = $(object).data('confirmationtext');
            var jsUrl = $(object).data('url');

            var dataParams = $(object).data();

            delete dataParams["url"];
            delete dataParams["confirmationtext"];



            swal({
                title: "Are you sure you want to delete?",
                text: confirmationtext,
                type: "error",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Yes, delete it!",
                closeOnconfirm: true
            }, function () {
                $.ajax({
                    type: "POST",
                    url : jsUrl,
                    data: dataParams,
                    beforeSend: function () {
                        showLoader();
                    },
                    success: function (data) {
                        if (data.success) {
                            loadRegistrations();
                            hideLoader();
                            toastr.success(data.message);
                        } else {
                            toastr.error(data.message);
                        }
                    }
                });
            });
        }


        $('#idExcelDownload').click(function () {
            $.ajax({

                url: '@Url.Action("ExcelDownload", "VaccinationOffice")',
                type: "GET",
                cache: false,
                xhrFields: {
                    responseType: 'blob'
                },
                beforeSend: function () {
                    showLoader();
                },
                success: function (data) {
                    var link = document.createElement('a');
                    var url = window.URL.createObjectURL(data);

                    link.href = window.URL.createObjectURL(data);
                    link.download = "Registrations.xlsx";
                    link.click();
                    link.remove();
                    window.URL.revokeObjectURL(url);
                    hideLoader();
                    toastr.success("File downloaded successfully.");
                },
                error: function (xhr) {
                    notify("error", result.responseText, 'danger');
                }
            });
        });


        function Delete1() {

            swal({
                title: "Are you sure you want to delete?",
                text: "Reset Employee registration!",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Yes, delete it!",
                closeOnconfirm: true
            }, function () {
                $.ajax({
                    type: "POST",
                    url: url,
                    success: function (data) {
                        if (data.success) {
                            toastr.success(data.message);
                            setTimeout(function () {
                                window.location.reload();
                            }, 700);
                        } else {
                            toastr.error(data.message);
                        }
                    }
                });
            });
        }
    </script>
}
