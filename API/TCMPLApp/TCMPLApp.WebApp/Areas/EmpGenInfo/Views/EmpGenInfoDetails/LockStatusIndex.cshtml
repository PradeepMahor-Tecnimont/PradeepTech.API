@model TCMPLApp.WebApp.Models.EmpLockStatusDetailsViewModel
@inject TCMPLApp.WebApp.Services.SharedViewLocalizer localizer
@{
    ViewData["Title"] = "Employee General Information - Lock Status";
}

@Html.AntiForgeryToken()
@section BreadCrumbs
    {
    <ol class="breadcrumb">
        <li class="breadcrumb-item "><a asp-action="Index" asp-controller="Home" asp-area="EmpGenInfo">Employee General information</a></li>
        <li class="breadcrumb-item active" aria-current="page">Lock Status </li>
    </ol>

}
@section Styles {
    <link href="@Url.Content("~/css/drome-style.css")" rel="stylesheet" type="text/css" asp-append-version="true" />
    <link href="~/lib/dropzone/dropzone.css" rel="stylesheet" asp-append-version="true" />
    <link href="~/lib/dropzone/basic.css" rel="stylesheet" asp-append-version="true" />
}
@Html.HiddenFor(m => m.FilterDataModel.IsActive)
<input readonly type="hidden" asp-for="@Model.FilterDataModel.Parent" />
<input readonly type="hidden" asp-for="@Model.FilterDataModel.IsPrimaryOpen" />
<input readonly type="hidden" asp-for="@Model.FilterDataModel.IsSecondaryOpen" />
<input readonly type="hidden" asp-for="@Model.FilterDataModel.IsMediclaimOpen" />
<input readonly type="hidden" asp-for="@Model.FilterDataModel.IsAadhaarOpen" />
<input readonly type="hidden" asp-for="@Model.FilterDataModel.IsPassportOpen" />
<input readonly type="hidden" asp-for="@Model.FilterDataModel.IsNominationOpen" />
<input readonly type="hidden" asp-for="@Model.FilterDataModel.IsGtliOpen" />
<input readonly type="hidden" asp-for="@Model.FilterDataModel.ExEmpno" />

<form asp-controller="EmpGenInfoDetails"
      asp-action="OnBeHalfGenInfoDetails"
      id="formOnBeHalfGenInfoDetails">

    <input type="hidden" asp-for="Empno" />
    <input type="hidden" asp-for="Parent" />
</form>

<div class="container-fluid bg-white border rounded shadow m-auto col-xl-11 p-2 ">
    <div class="app-h4 app-card-header mb-2">
        <p>Lock Status</p>
    </div>
    <div class="d-flex flex-row">
        <a class="btn btn-outline-primary btn-sm filteredmarker-border border-white"
           data-jqueryselector="openmodal"
           data-modalcontainer="modalcontainer"
           data-modalpopupwidth="rightw35"
           data-url='@Url.Action("FilterGet", "EmpGenInfoDetails", new { Area = "EmpGenInfo" })'
           data-modaltitle="Filters - Lock Status"
           data-modalheader="Filters - Lock Status">
            <i class="fas fa-filter"></i>&nbsp;Filters
        </a>
        <a class="btn btn-outline-danger btn-sm border-white filteredmarker-visibility m-l-5"
           data-actionid="EmpGenInfoLockStatusDetails"
           data-url='@Url.Action("ResetFilter", "EmpGenInfoDetails", new { Area = "EmpGenInfo" })'
           href="#"
           onclick="resetFilter(event, this);"
           style="display: none;">
            <i class="fas fa-filter"></i> Reset
        </a>
        <a title="Bulk Lock / Open" class="btn btn-outline-primary btn-sm border border-white" href="#"
           data-jqueryselector="openmodal"
           data-modalcontainer="modalcontainer"
           data-modalpopupwidth="rightw35"
           data-url='@Url.Action("BulkActionEdit", "EmpGenInfoDetails", new { Area = "EmpGenInfo" })'
           data-statichtmlsourcedivid=""
           data-modaltitle="Edit Bulk Lock / Open"
           data-modalheader="Edit Bulk Lock / Open">
            <i class="fas fa-edit"></i> Bulk Lock / Open
        </a>


        <form asp-controller="EmpGenInfoDetails"
              asp-action="UpdateNewJoinee">
            <button class="btn btn-sm btn-primary f-w-600 m-l-30 btn-glow-blink" type="submit"
                    data-loading-text='<span class="spinner-border spinner-border-sm" role="diagram"></span>@localizer["Waiting..."]'
                    data-text="@localizer["Update New Joinees"]">
                @localizer["Update New Joinees"]
            </button>
        </form>
    </div>



    <div class="m-1"></div>
    <div class="bg-gray-active rounded ">
        <div class="input-group pt-1 pl-1 pr-1 ">
            <input type="text" class="form-control form-control-sm border" id="GenericSearch" name="GenericSearch" placeholder="Search...">
            <div class="input-group-append">
                <button class="btn btn-sm btn-outline-info" type="button" id="buttonSearch"><i class="fa fa-search"></i></button>
            </div>
        </div>

        <table id="tbEmpLockInfo" class="table table-striped table-bordered table-responsive-lg table-hover ">
            <thead class="bg-info text-white">
                <tr>
                    <th>Employee</th>
                    <th>Parent</th>
                    <th>Primary Info Lock</th>
                    <th>Secondary Info Lock</th>
                    <th>Nomination lock</th>
                    <th>Medicalim lock</th>
                    <th>Adhaar lock</th>
                    <th>Passport lock</th>
                    <th>GTLI lock</th>
                    <th>&nbsp;</th>
                    <th>&nbsp;</th>
                </tr>
            </thead>
        </table>

        <div id="result"></div>
    </div>
</div>

@section Scripts{

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="~/js/site-rap.js" asp-append-version="true"></script>
    <script>

        $(document).ready(function () {
            loadEmpLockStatusDetailsDataTable();

        });

        function localScript() {
            initSelect2();
            $(document).ready(function () {

                $('#LockedAll').click(function () {
                    if (this.checked) {
                        $('.locked').each(function () {
                            this.checked = true;
                        });
                    } else {
                        $('.locked').each(function () {
                            this.checked = false;
                        });
                    }
                })
                $('.locked').click(function () {
                    if ($('.locked:checked').length == $('.locked').length) {
                        $('#LockedAll').prop('checked', true);
                    } else {
                        $('#LockedAll').prop('checked', false);
                    }
                });


                $('#OpenAll').click(function () {
                    if (this.checked) {
                        $('.open').each(function () {
                            this.checked = true;
                        });
                    } else {
                        $('.open').each(function () {
                            this.checked = false;
                        });
                    }
                });
                $('.open').click(function () {
                    if ($('.open:checked').length == $('.open').length) {
                        $('#OpenAll').prop('checked', true);
                    } else {
                        $('#OpenAll').prop('checked', false);
                    }
                });

            });
        };

        let vVUloadEmpLockStatusDetails = "@Url.Action("GetListsloadEmpLockStatusDetails", "EmpGenInfoDetails")";

        function loadEmpLockStatusDetailsDataTable() {
            genericLoadDataTable({
                pDataTableId: "#tbEmpLockInfo",
                pColumns: datatableColumns,
                pUrl: vVUloadEmpLockStatusDetails,
                pUrlParams: {
                    genericSearch: $('#GenericSearch').val() ? $('#GenericSearch').val() : null,
                    parent: $('#Parent').val(),
                    parent: $('#FilterDataModel_Parent').val() ? $('#FilterDataModel_Parent').val() : null,
                    isPrimaryOpen: $('#FilterDataModel_IsPrimaryOpen').val() ? $('#FilterDataModel_IsPrimaryOpen').val() : null,
                    isSecondaryOpen: $('#FilterDataModel_IsSecondaryOpen').val() ? $('#FilterDataModel_IsSecondaryOpen').val() : null,
                    isMediclaimOpen: $('#FilterDataModel_IsMediclaimOpen').val() ? $('#FilterDataModel_IsMediclaimOpen').val() : null,
                    isAadhaarOpen: $('#FilterDataModel_IsAadhaarOpen').val() ? $('#FilterDataModel_IsAadhaarOpen').val() : null,
                    isPassportOpen: $('#FilterDataModel_IsPassportOpen').val() ? $('#FilterDataModel_IsPassportOpen').val() : null,
                    isNominationOpen: $('#FilterDataModel_IsNominationOpen').val() ? $('#FilterDataModel_IsNominationOpen').val() : null,
                    isGtliOpen: $('#FilterDataModel_IsGtliOpen').val() ? $('#FilterDataModel_IsGtliOpen').val() : null,
                    exEmpno: $('#FilterDataModel_ExEmpno').val() ? $('#FilterDataModel_ExEmpno').val() : null,
                },
                pRequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()

            });
        };

        @if ((bool)@Context.Items["isMobile"] == false)
        {
            <text>

                let datatableColumns = [
                    {
                        data: null,
                        render: function (data, type, row) {
                            return data.empno + " - " + data.empName
                        },
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            return data.parent + " - " + data.parentName
                        },
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            if (data.isPrimLockOpen == "1") {
                                return "Open";
                            }
                            else {
                                return "Locked";
                            }
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            if (data.isSecondaryLockOpen == "1") {
                                return "Open";
                            }
                            else {
                                return "Locked";
                            }
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            var tempEmp = "'" + data.empno + "'";
                            var tempFileType = "'" + "NO" + "'";
                            var tempLink = '';
                            if (data.isNomLockOpen == "1") {
                                tempLink = "Open";
                            }
                            else {
                                tempLink = "Locked";
                            }
                            if (data.nominationExists == "1") {
                                tempLink = tempLink + '<a class="btn btn-outline-primary btn-sm  border-none" style="float:right" href="#" onclick="downloadScanFile(' + tempFileType + ',' + tempEmp + ')"    title="Download Nomination form"><i class="fas fa-file-word"></i></a>';
                            }
                            return tempLink;
                        }



                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            if (data.isFmlyLockOpen == "1") {
                                return "Open";
                            }
                            else {
                                return "Locked";
                            }
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            var tempEmp = "'" + data.empno + "'";
                            var tempFileType = "'" + "AC" + "'";
                            var tempLink = '';
                            if (data.isAdhaarLock == "1") {
                                tempLink = "Open";
                            }
                            else {
                                tempLink = "Locked";
                            }
                            if (data.aadhaarExists == "1") {
                                tempLink = tempLink + '<a class="btn btn-outline-primary btn-sm  border-none" style="float:right" href="#" onclick="downloadScanFile(' + tempFileType + ',' + tempEmp + ')"    title="Download Aadhaar form"><i class="fas fa-download"></i></a>';
                            }
                            return tempLink;
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            var tempEmp = "'" + data.empno + "'";
                            var tempFileType = "'" + "PP" + "'";
                            var tempLink = '';
                            if (data.isPpLock == "1") {
                                tempLink = "Open";
                            }
                            else {
                                tempLink = "Locked";
                            }
                            if (data.ppExists == "1") {
                                tempLink = tempLink + '<a class="btn btn-outline-primary btn-sm  border-none" style="float:right" href="#" onclick="downloadScanFile(' + tempFileType + ',' + tempEmp + ')"    title="Download Passport form"><i class="fas fa-download"></i></a>';
                            }
                            return tempLink;
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            var tempEmp = "'" + data.empno + "'";
                            var tempFileType = "'" + "GT" + "'";
                            var tempLink = '';
                            if (data.isGtliLock == "1") {
                                tempLink = "Open";
                            }
                            else {
                                tempLink = "Locked";
                            }
                            if (data.gtliExists == "1") {
                                tempLink = tempLink + '<a class="btn btn-outline-primary btn-sm  border-none" style="float:right" href="#" onclick="downloadScanFile(' + tempFileType + ',' + tempEmp + ')"    title="Download GTLI form"><i class="fas fa-download"></i></a>';
                            }
                            return tempLink;
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            return '<button title="Edit" class="btn btn-outline-primary btn-sm border-none" ' +
                                ' data-jqueryselector="openmodal" ' +
                                ' data-modalcontainer="modalcontainer" ' +
                                ' data-url="@Url.Action("LockStatusEdit", "EmpGenInfoDetails", new { Area = "EmpGenInfo" })"' +
                                ' data-modalpopupwidth="rightw35" ' +
                                ' data-empno="' + data.empno + '"' +
                                ' data-empName="' + data.empName + '"' +
                                ' data-modaltitle="Lock Status edit" ' +
                                ' data-modalheader="Lock Status edit" >' +
                                ' <i class="fas fa-lock" aria-hidden="true"></i> ' +
                                ' </button>';
                        },
                        className: "td-icon",
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            var tempEmp = "'" + data.empno + "'";
                            return '<a class="btn btn-sm-icon" href="#" onclick="GotoDetails(' + tempEmp + ')" title="Detail"><i class="far fa-eye"></i></a>';
                        },
                        className: "td-icon",
                    }
                ];


            </text>
        };


        $("#GenericSearch").keypress(function (event) {
            if (event.keyCode === 13) {
                if ($("#GenericSearch").length) {
                    loadEmpLockStatusDetailsDataTable();
                }
            }
        });

        $('#buttonSearch').on('click', function () {

            if ($("#GenericSearch").length) {
                loadEmpLockStatusDetailsDataTable();
            }
        });

        function PostSave(data) {
            if (data.success) {
                $("#modalcontainer").modal('hide');
                hideLoader();
                loadEmpLockStatusDetailsDataTable();
                notify('success', data.response, 'Success');
            }
        };

        function PostFilterReLoadDataTable(data) {

            $("#modalcontainer").modal('hide');


            $("#FilterDataModel_Parent").val(data.parent);
            $("#FilterDataModel_IsPrimaryOpen").val(data.isPrimaryOpen);
            $("#FilterDataModel_IsSecondaryOpen").val(data.isSecondaryOpen);
            $("#FilterDataModel_IsMediclaimOpen").val(data.isMediclaimOpen);
            $("#FilterDataModel_IsAadhaarOpen").val(data.isAadhaarOpen);
            $("#FilterDataModel_IsPassportOpen").val(data.isPassportOpen);
            $("#FilterDataModel_IsNominationOpen").val(data.isNominationOpen);
            $("#FilterDataModel_IsGtliOpen").val(data.isGtliOpen);
            $("#FilterDataModel_ExEmpno").val(data.exEmpno);


            loadEmpLockStatusDetailsDataTable();
            hideLoader();
        }

        function GotoDetails(empno) {

            $('#Empno').val(empno);
            var frm = $('#formOnBeHalfGenInfoDetails');
            frm.submit();
        }

        function downloadScanFile(pFileType, pEmpno) {


            if (pFileType == null || pFileType == '') {
                toastr.error('Invalid fileType ');
                return;
            }
            if (pEmpno == null || pEmpno == '') {
                toastr.error('Invalid empno');
                return;
            }


            $.ajax({
                headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() },
                url: '@Url.Action("DownloadScanFile", "EmpGenInfoDetails", new {Area = "EmpGenInfo" })',
                type: "POST",
                data: {
                    fileType: pFileType,
                    empno: pEmpno
                },
                cache: false,
                xhr: function () {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState == 2) {
                            if (xhr.status == 200) {
                                xhr.responseType = "blob";
                            }
                        }
                    };
                    return xhr;
                },
                beforeSend: function () {
                    showLoader();
                },

                success: function (blob, status, xhr) {

                    var filename = "";
                    var disposition = xhr.getResponseHeader('Content-Disposition');
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        var matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                    }
                    var link = document.createElement('a');
                    var url = window.URL.createObjectURL(blob);

                    link.href = window.URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                    link.remove();
                    window.URL.revokeObjectURL(url);
                    toastr.success("File downloaded successfully.");
                    hideLoader();
                },
                error: function (xhr) {
                    showError(xhr);
                    hideLoader();
                }
            });
        }

    </script>
}