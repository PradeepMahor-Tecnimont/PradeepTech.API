@model TCMPLApp.WebApp.Models.LogbookViewModel;

@{
    ViewData["Title"] = "Logbook";
}

@section Styles {
    <link href="@Url.Content("~/css/drome-style.css")" rel="stylesheet" type="text/css" asp-append-version="true" />
}

<input id="Projno" readonly type="hidden" asp-for="@Model.FilterDataModel.Projno" />
<input id="Costcode" readonly type="hidden" asp-for="@Model.FilterDataModel.CostCode" />

<div class="col-12">
    <P>Please wait until excel file download...</P>
</div>
@section Scripts {

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>

        $(document).ready(function () {
                var urlCheckReportHit = "@Url.Action("CheckReportHit", "Logbook", new { Area = "Logbook" })";
                var urlGetReport = "@Url.Action("GetReport", "Logbook", new { Area = "Logbook" })";
                CheckReportHit(urlCheckReportHit, urlGetReport);
        });

        function localScript() {
            initSelect2();

        }

        function CheckReportHit(urlCheckReportHit, urlGetReport) {
            $.ajax({
                url: urlCheckReportHit,
                type: 'GET',
                beforeSend: function () {
                    showLoader();
                },
                success: function (data) {
                    if (data != null) {
                        reportHitEntry(urlGetReport);
                    }
                },
                error: function (result) {
                    showError(result);
                },
                complete: function(){
                    hideLoader();
                }
            });
        }

        function reportHitEntry(url) {
            $.ajax({
                url: url,
                type: 'GET',
                beforeSend: function () {
                    showLoader();
                },
                success: function (data, status, xhr) {
                    if (data.messageType == "OK") {
                        //console.log(data.messageFileContent);
                        var blob = convertToBlob(data.messageFileContent.fileContents, data.messageFileContent.contentType);
                        var link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = data.messageFileContent.fileDownloadName;
                        link.click();
                        notify("success", data.messageText, 'Success');
                    }
                    if (data.messageType == "KO") {
                        notify("error", data.messageText, 'Error');
                    }
                },
                error: function (result) {
                    errorText = result.responseText.indexOf("divErrorMessage") == -1 ? result.responseText : ($(result.responseText).find("div[id*=divErrorMessage]").text()).replace("text-danger", "text-white");
                    notify("error", errorText, 'Error');
                },
            });
        }

    </script>
}